<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
	<title>D3.js v4 Mapping Tutorial 1</title>
</head>
<body>

	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script>

	d3.queue()
	.defer(d3.csv, "data/gps.csv")
	.defer(d3.csv, "data/cc_data.csv")
	.defer(d3.csv, "data/car-assignments.csv")
	.defer(d3.csv, "data/loyalty_data.csv")
	.await(analyze);

function analyze(error, gps, ccData, carAssign, loyalty){
	if (error) {
		console.log(error);
	}

	var data = gps;

	var projection = d3
	.geoMercator()
	.scale(300000)
	.rotate([0.0, 0.0, 0])
	.center([24.86, 36.06]);

	var path = d3.geoPath().projection(projection);　

	var map = d3.select("body")
	.append("svg")
	.attr("width", 800)
	.attr("height", 500);

	console.log(data);


		var a = getCarRoute(1, data, 1, data[0].Timestamp, data[data.length-1].Timestamp);
		var stops = findStops(a);

		d3.json("data/Abila.geojson", drawMaps);


		function drawMaps(geojson) {
			map.selectAll("path")
			.data(geojson.features)
			.enter()
			.append("path")
			.attr("d", path)
			.attr("fill", "green")
			.attr("fill-opacity", 0)
			.attr("stroke", "#000000");



			// add circles to svg
			map.selectAll("circles")
			.data(a).enter()
			.append("circle")
			.attr("cx", function (d) { return projection([d.long, d.lat])[0]; })
			.attr("cy", function (d) { return projection([d.long, d.lat])[1]; })
			.attr("r", "1px")
			.attr("fill", "red");

			plotStops(stops);


		}

		function getCarRoute(id, data, res, start, end){
			var a =[];
			var format = d3.timeParse('%m/%d/%Y %H:%M:%S');
			var time = format(start);
			end = format(end);
			var i = 0;

			while (time < end ) {
				if (data[i].id == id) {
					var b = data[i];
					a.push(b);
				}
				i+=res;
				time = format(data[i].Timestamp);
			}
			return a;
		}

	function findStops(gpsData){
		var format = d3.timeParse('%m/%d/%Y %H:%M:%S');
		var stops = [];
		var dif = 0;
		for (var i = 0; i < gpsData.length-1; i++) {

			dif = d3.timeMinute.count( format(gpsData[i].Timestamp), format(gpsData[i+1].Timestamp));


			if ( dif >= 5  ) {
				var stop = {
					Timestamp : gpsData[i].Timestamp,
					id : gpsData[i].id,
					lat : gpsData[i].lat,
					long : gpsData[i].long,
				 	stopTime : dif
				}

				stops.push(stop);
			}

		}
		return stops;
	}

	function plotStops(stops){
		map.selectAll("circles")
		.data(stops).enter()
		.append("circle")
		.attr("cx", function (d) { return projection([d.long, d.lat])[0]; })
		.attr("cy", function (d) { return projection([d.long, d.lat])[1]; })
		.attr("r", "1px")
		.attr("fill", "blue");
	}

}



</script>
</body>
</html>
